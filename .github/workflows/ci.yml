---
# =============================================================================
# CI Pipeline
# =============================================================================
# Uses same Makefile verbs as local development
# Rust 2024 edition lints enabled via CI_MODE=1
# =============================================================================

name: CI

permissions:
  contents: "read"
  security-events: write
  actions: read

on:  # yamllint disable-line rule:truthy
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  CARGO_TERM_COLOR: always

jobs:
  lint:
    name: Lint (Rust 2024)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - run: make lint CI_MODE=1

  test:
    name: Test (${{ matrix.rust }})
    needs: [lint]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        rust: [stable, beta]
    steps:
      - uses: actions/checkout@v6
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
      - uses: Swatinem/rust-cache@v2
      - run: make test TEST_THREADS=4

  validate:
    name: Architecture Validation
    needs: [lint]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: make validate STRICT=1
      - name: Check Provider Traits Location
        run: |
          VIOLATIONS=$(
            grep -r "use mcb_application::ports::providers" \
              crates/mcb-providers/src/ 2>/dev/null || true
          )
          if [ -n "$VIOLATIONS" ]; then
            echo "VIOLATION: Provider traits should be imported from mcb-domain"
            echo "$VIOLATIONS"
            exit 1
          fi

  golden-tests:
    name: Golden Acceptance Tests
    needs: [test]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: make test SCOPE=golden TEST_THREADS=2

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: "read"
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language:
          - "rust"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: +security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:rust"

  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - run: bash .github/setup-ci.sh --install-audit
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: make audit

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: make docs

  coverage:
    name: Coverage
    needs: [test]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6
      - run: bash .github/setup-ci.sh --install-coverage
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: make coverage LCOV=1 TEST_THREADS=4
      - uses: codecov/codecov-action@v5
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false

  release-build:
    name: Release (${{ matrix.target }})
    if: github.ref == 'refs/heads/main'
    needs: [test, validate]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc
    steps:
      - uses: actions/checkout@v6
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
      - run: make build RELEASE=1
      - uses: actions/upload-artifact@v6
        with:
          name: mcb-${{ matrix.target }}
          path: >-
            target/release/mcb${{ matrix.os == 'windows-latest' &&
            '.exe' || '' }}
