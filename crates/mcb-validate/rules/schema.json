{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://mcp-context-browser.com/schemas/rule/v2",
  "title": "MCB Validation Rule Schema",
  "description": "Schema for YAML-based validation rules in MCP Context Browser",
  "type": "object",
  "properties": {
    "schema": {
      "type": "string",
      "enum": ["rule/v1", "rule/v2", "rule/v3", "template/v1"],
      "description": "Schema version identifier"
    },
    "id": {
      "type": "string",
      "pattern": "^[A-Z]{2,8}\\d{3,4}$",
      "description": "Unique rule identifier (e.g., CA001, QUAL001)"
    },
    "name": {
      "type": "string",
      "minLength": 3,
      "maxLength": 100,
      "description": "Human-readable rule name"
    },
    "category": {
      "type": "string",
      "enum": [
        "architecture",
        "quality",
        "solid",
        "dependency_injection",
        "configuration",
        "web_framework",
        "migration",
        "metrics",
        "performance"
      ],
      "description": "Rule category for grouping"
    },
    "severity": {
      "type": "string",
      "enum": ["error", "warning", "info"],
      "description": "Default severity level"
    },
    "enabled": {
      "type": "boolean",
      "default": true,
      "description": "Whether rule is enabled by default"
    },
    "description": {
      "type": "string",
      "minLength": 10,
      "maxLength": 500,
      "description": "Detailed description of what the rule checks"
    },
    "rationale": {
      "type": "string",
      "minLength": 10,
      "maxLength": 500,
      "description": "Why this rule matters"
    },
    "engine": {
      "type": "string",
      "enum": ["rust-rule-engine", "rusty-rules", "ast"],
      "description": "Which rule engine to use for execution"
    },
    "selectors": {
      "type": "array",
      "description": "AST selectors for multi-language rules",
      "items": {
        "type": "object",
        "properties": {
          "language": {
            "type": "string",
            "enum": ["rust", "python", "javascript", "typescript", "go", "java"],
            "description": "Programming language"
          },
          "node_type": {
            "type": "string",
            "description": "AST node type to match (e.g., function_item, function_definition)"
          },
          "pattern": {
            "type": "string",
            "description": "Tree-sitter query pattern"
          }
        },
        "required": ["language", "node_type"]
      }
    },
    "ast_query": {
      "type": "string",
      "description": "Tree-sitter query string for complex AST matching"
    },
    "lint_select": {
      "type": "array",
      "description": "Linter rule codes to integrate (Ruff/Clippy)",
      "items": {
        "type": "string",
        "pattern": "^[A-Z]+[0-9]+$|^clippy::[a-zA-Z_]+$|^[A-Z][0-9]+$"
      }
    },
    "config": {
      "type": "object",
      "description": "Rule-specific configuration validated by validator/garde"
    },
    "metrics": {
      "type": "object",
      "description": "Metrics thresholds for schema v3 rules",
      "properties": {
        "cognitive_complexity": {
          "type": "object",
          "properties": {
            "max": {"type": "integer", "minimum": 1},
            "severity": {"type": "string", "enum": ["error", "warning", "info"]},
            "languages": {"type": "array", "items": {"type": "string"}}
          },
          "required": ["max"]
        },
        "cyclomatic_complexity": {
          "type": "object",
          "properties": {
            "max": {"type": "integer", "minimum": 1},
            "severity": {"type": "string", "enum": ["error", "warning", "info"]},
            "languages": {"type": "array", "items": {"type": "string"}}
          },
          "required": ["max"]
        },
        "function_length": {
          "type": "object",
          "properties": {
            "max": {"type": "integer", "minimum": 1},
            "severity": {"type": "string", "enum": ["error", "warning", "info"]},
            "languages": {"type": "array", "items": {"type": "string"}}
          },
          "required": ["max"]
        },
        "nesting_depth": {
          "type": "object",
          "properties": {
            "max": {"type": "integer", "minimum": 1},
            "severity": {"type": "string", "enum": ["error", "warning", "info"]},
            "languages": {"type": "array", "items": {"type": "string"}}
          },
          "required": ["max"]
        }
      }
    },
    "duplication": {
      "type": "object",
      "description": "Duplication detection configuration for Phase 5 clone analysis",
      "properties": {
        "clone_type": {
          "type": "string",
          "enum": ["exact", "renamed", "gapped", "semantic"],
          "description": "Type of clone to detect"
        },
        "min_lines": {
          "type": "integer",
          "minimum": 1,
          "description": "Minimum lines to consider a duplicate"
        },
        "min_tokens": {
          "type": "integer",
          "minimum": 1,
          "description": "Minimum tokens to consider a duplicate"
        },
        "similarity_threshold": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Similarity threshold (0.0-1.0)"
        },
        "max_gap_size": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum gap size for gapped clones"
        },
        "languages": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Languages to analyze"
        }
      },
      "required": ["clone_type", "min_lines", "min_tokens", "similarity_threshold"]
    },
    "rule": {
      "description": "Engine-specific rule definition",
      "oneOf": [
        {
          "type": "object",
          "properties": {
            "type": {"type": "string"},
            "condition": {"type": "string"},
            "pattern": {"type": "string"},
            "message": {"type": "string"}
          }
        },
        {
          "type": "string",
          "description": "GRL (Grule Rule Language) syntax for rust-rule-engine"
        }
      ]
    },
    "validation": {
      "type": "object",
      "description": "Field validations using validator/garde syntax",
      "properties": {
        "fields": {
          "type": "object",
          "patternProperties": {
            "^[a-zA-Z_][a-zA-Z0-9_]*$": {
              "type": "array",
              "items": {"type": "string"}
            }
          }
        }
      }
    },
    "fixes": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "type": {"type": "string"},
          "pattern": {"type": "string"},
          "message": {"type": "string"}
        }
      },
      "description": "Suggested fixes for violations"
    },
    "_template": {
      "type": "string",
      "description": "Template to extend (for DRY rule definitions)"
    },
    "_extends": {
      "type": "string",
      "description": "Rule to extend"
    },
    "_base": {
      "type": "boolean",
      "description": "Whether this is a base template"
    }
  },
  "required": ["schema", "id", "name", "category", "severity", "description", "rationale"],
  "if": {
    "properties": { "schema": { "const": "rule/v1" } }
  },
  "then": {
    "required": ["engine", "rule"]
  },
  "else": {
    "if": {
      "properties": { "schema": { "const": "rule/v2" } }
    },
    "then": {
      "anyOf": [
        { "required": ["engine", "rule"] },
        { "required": ["selectors"] },
        { "required": ["lint_select"] },
        { "required": ["ast_query"] }
      ]
    },
    "else": {
      "if": {
        "properties": { "schema": { "const": "rule/v3" } }
      },
      "then": {
        "anyOf": [
          { "required": ["metrics"] },
          { "required": ["duplication"] },
          { "required": ["engine", "rule"] },
          { "required": ["selectors"] },
          { "required": ["lint_select"] },
          { "required": ["ast_query"] }
        ]
      }
    }
  }
}