<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MCP Context Browser Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx-ext-sse@2.2.2/sse.js"></script>
    <script src="https://unpkg.com/hyperscript.org@0.9.12"></script>
    <style>
        .status-healthy { color: #16a34a; }
        .status-degraded { color: #ca8a04; }
        .status-unhealthy { color: #dc2626; }
        .status-running { color: #16a34a; }
        .status-stopped { color: #6b7280; }
        .status-starting { color: #2563eb; }
        .status-stopping { color: #ca8a04; }
        .card { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s; cursor: pointer; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover:not(:disabled) { background: #1d4ed8; }
        .btn-success { background: #16a34a; color: white; }
        .btn-success:hover:not(:disabled) { background: #15803d; }
        .btn-warning { background: #ca8a04; color: white; }
        .btn-warning:hover:not(:disabled) { background: #a16207; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover:not(:disabled) { background: #b91c1c; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .sse-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 0.5rem; }
        .sse-connected { background: #16a34a; animation: pulse 2s infinite; }
        .sse-disconnected { background: #dc2626; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .event-log { max-height: 300px; overflow-y: auto; }
        .event-item { border-left: 3px solid; padding: 0.5rem 1rem; margin-bottom: 0.5rem; font-size: 0.875rem; }
        .event-indexing { border-color: #2563eb; background: #eff6ff; }
        .event-service { border-color: #16a34a; background: #f0fdf4; }
        .event-config { border-color: #ca8a04; background: #fefce8; }
        .event-health { border-color: #8b5cf6; background: #f5f3ff; }
        .event-error { border-color: #dc2626; background: #fef2f2; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <nav class="bg-gray-800 text-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <span class="text-xl font-bold">MCP Context Browser</span>
                    <span class="ml-2 text-sm text-gray-400">Admin</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="sse-status" class="flex items-center text-sm">
                        <span class="sse-indicator sse-disconnected" id="sse-indicator"></span>
                        <span id="sse-text">Disconnected</span>
                    </span>
                    <a href="/" class="px-3 py-2 rounded-md text-sm font-medium bg-gray-900">Dashboard</a>
                    <a href="/ui/config" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-gray-700">Config</a>
                    <a href="/ui/health" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-gray-700">Health</a>
                    <a href="/ui/indexing" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-gray-700">Indexing</a>
                    <a href="/ui/browse" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-gray-700">Browse</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>
            <p class="mt-2 text-gray-600">System overview and real-time metrics via SSE</p>
        </div>

        <!-- Health Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card" id="health-card">
                <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Status</h3>
                <p class="mt-2 text-3xl font-semibold status-healthy" id="status-value">HEALTHY</p>
            </div>

            <div class="card" id="uptime-card">
                <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Uptime</h3>
                <p class="mt-2 text-3xl font-semibold text-gray-900" id="uptime-value">--</p>
            </div>

            <div class="card" id="active-ops-card">
                <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Active Operations</h3>
                <p class="mt-2 text-3xl font-semibold text-gray-900" id="active-ops-value">--</p>
            </div>
        </div>

        <!-- Metrics Section -->
        <div class="card mb-8" id="metrics-section">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Performance Metrics</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div>
                    <p class="text-sm text-gray-500">Total Queries</p>
                    <p class="text-2xl font-semibold" id="metric-total-queries">--</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Success Rate</p>
                    <p class="text-2xl font-semibold" id="metric-success-rate">--</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Cache Hit Rate</p>
                    <p class="text-2xl font-semibold" id="metric-cache-hit">--</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Avg Response Time</p>
                    <p class="text-2xl font-semibold" id="metric-avg-response">--</p>
                </div>
            </div>
        </div>

        <!-- Services Section -->
        <div class="card mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">Services</h2>
                <button class="btn btn-primary btn-sm" onclick="refreshServices()">Refresh</button>
            </div>
            <div id="services-list" class="space-y-3">
                <p class="text-gray-500 text-sm">Loading services...</p>
            </div>
        </div>

        <!-- Event Log Section -->
        <div class="card mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">Live Event Log</h2>
                <button class="btn btn-sm btn-secondary" onclick="clearEventLog()">Clear</button>
            </div>
            <div id="event-log" class="event-log">
                <p class="text-gray-500 text-sm text-center py-4">Waiting for events...</p>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h2>
            <div class="flex flex-wrap gap-4">
                <button class="btn btn-primary"
                        hx-post="/config/reload"
                        hx-swap="none"
                        hx-confirm="Reload configuration from file?">
                    Reload Config
                </button>
                <button class="btn btn-warning" onclick="healthCheckAll()">
                    Health Check All
                </button>
                <button class="btn btn-danger"
                        hx-post="/shutdown"
                        hx-vals='{"timeout_secs": 30}'
                        hx-confirm="Are you sure you want to shutdown the server?"
                        hx-swap="none">
                    Shutdown Server
                </button>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-gray-400 py-4 mt-8">
        <div class="max-w-7xl mx-auto px-4 text-center text-sm">
            MCP Context Browser v0.1.1 | Admin Panel | SSE Real-time Updates
        </div>
    </footer>

    <script>
        // =========================================================================
        // SSE Connection Management
        // =========================================================================
        let eventSource = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const reconnectDelay = 3000;

        function connectSSE() {
            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource('/events');

            eventSource.onopen = function() {
                console.log('SSE connected');
                reconnectAttempts = 0;
                updateSSEStatus(true);
                addEventToLog('system', 'Connected to event stream');
            };

            eventSource.onerror = function(e) {
                console.error('SSE error:', e);
                updateSSEStatus(false);

                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    addEventToLog('error', `Connection lost. Reconnecting (${reconnectAttempts}/${maxReconnectAttempts})...`);
                    setTimeout(connectSSE, reconnectDelay);
                } else {
                    addEventToLog('error', 'Max reconnect attempts reached. Please refresh the page.');
                }
            };

            // Register event handlers for each event type
            const eventTypes = [
                'IndexRebuild', 'IndexingStarted', 'IndexingProgress', 'IndexingCompleted',
                'SyncCompleted', 'CacheInvalidate', 'SnapshotCreated', 'FileChangesDetected',
                'ServiceStateChanged', 'ConfigReloaded', 'HealthCheckCompleted',
                'MetricsSnapshot', 'SearchExecuted'
            ];

            eventTypes.forEach(eventType => {
                eventSource.addEventListener(eventType, function(e) {
                    handleEvent(eventType, JSON.parse(e.data));
                });
            });
        }

        function updateSSEStatus(connected) {
            const indicator = document.getElementById('sse-indicator');
            const text = document.getElementById('sse-text');

            if (connected) {
                indicator.classList.remove('sse-disconnected');
                indicator.classList.add('sse-connected');
                text.textContent = 'Live';
            } else {
                indicator.classList.remove('sse-connected');
                indicator.classList.add('sse-disconnected');
                text.textContent = 'Disconnected';
            }
        }

        // =========================================================================
        // Event Handlers
        // =========================================================================
        function handleEvent(eventType, data) {
            console.log('Received event:', eventType, data);

            switch (eventType) {
                case 'ServiceStateChanged':
                    handleServiceStateChanged(data);
                    addEventToLog('service', `Service "${data.name}" state: ${data.state}`);
                    break;

                case 'IndexingStarted':
                    addEventToLog('indexing', `Indexing started: ${data.collection || 'unknown'} (${data.total_files || 0} files)`);
                    break;

                case 'IndexingProgress':
                    const progress = data.total_files > 0
                        ? Math.round((data.processed_files / data.total_files) * 100)
                        : 0;
                    addEventToLog('indexing', `Indexing progress: ${progress}% (${data.processed_files}/${data.total_files})`);
                    break;

                case 'IndexingCompleted':
                    addEventToLog('indexing', `Indexing completed: ${data.collection || 'unknown'} - ${data.total_indexed || 0} chunks indexed`);
                    break;

                case 'ConfigReloaded':
                    addEventToLog('config', `Configuration reloaded${data.changes ? ': ' + data.changes.join(', ') : ''}`);
                    break;

                case 'HealthCheckCompleted':
                    handleHealthCheckCompleted(data);
                    addEventToLog('health', `Health check: ${data.status || 'unknown'}`);
                    break;

                case 'MetricsSnapshot':
                    handleMetricsSnapshot(data);
                    break;

                case 'SearchExecuted':
                    addEventToLog('indexing', `Search executed: "${data.query?.substring(0, 30)}..." - ${data.results_count || 0} results`);
                    break;

                case 'CacheInvalidate':
                    addEventToLog('config', `Cache invalidated: ${data.collection || 'all'}`);
                    break;

                default:
                    addEventToLog('system', `Event: ${eventType}`);
            }
        }

        function handleServiceStateChanged(data) {
            refreshServices();
        }

        function handleHealthCheckCompleted(data) {
            if (data.status) {
                const statusEl = document.getElementById('status-value');
                statusEl.textContent = data.status.toUpperCase();
                statusEl.className = 'mt-2 text-3xl font-semibold status-' + data.status;
            }
        }

        function handleMetricsSnapshot(data) {
            if (data.total_queries !== undefined) {
                document.getElementById('metric-total-queries').textContent = data.total_queries;
            }
            if (data.successful_queries !== undefined && data.total_queries > 0) {
                const rate = ((data.successful_queries / data.total_queries) * 100).toFixed(1);
                document.getElementById('metric-success-rate').textContent = rate + '%';
            }
            if (data.cache_hit_rate !== undefined) {
                document.getElementById('metric-cache-hit').textContent = (data.cache_hit_rate * 100).toFixed(1) + '%';
            }
            if (data.average_response_time_ms !== undefined) {
                document.getElementById('metric-avg-response').textContent = data.average_response_time_ms.toFixed(1) + 'ms';
            }
            if (data.uptime_seconds !== undefined) {
                document.getElementById('uptime-value').textContent = formatUptime(data.uptime_seconds);
            }
        }

        // =========================================================================
        // Event Log Management
        // =========================================================================
        function addEventToLog(type, message) {
            const log = document.getElementById('event-log');
            const emptyMessage = log.querySelector('.text-gray-500');
            if (emptyMessage) {
                emptyMessage.remove();
            }

            const eventEl = document.createElement('div');
            eventEl.className = 'event-item event-' + type;
            eventEl.innerHTML = `
                <span class="font-medium">${new Date().toLocaleTimeString()}</span>
                <span class="ml-2">${escapeHtml(message)}</span>
            `;

            log.insertBefore(eventEl, log.firstChild);

            // Keep only last 50 events
            while (log.children.length > 50) {
                log.removeChild(log.lastChild);
            }
        }

        function clearEventLog() {
            const log = document.getElementById('event-log');
            log.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Event log cleared</p>';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // =========================================================================
        // Services Management
        // =========================================================================
        async function refreshServices() {
            try {
                const response = await fetch('/services');
                const services = await response.json();
                renderServices(services);
            } catch (e) {
                console.error('Error fetching services:', e);
                document.getElementById('services-list').innerHTML =
                    '<p class="text-red-500 text-sm">Error loading services</p>';
            }
        }

        function renderServices(services) {
            const container = document.getElementById('services-list');

            if (!services || services.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No services registered</p>';
                return;
            }

            container.innerHTML = services.map(service => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div>
                        <span class="font-medium">${escapeHtml(service.name)}</span>
                        <span class="ml-2 text-sm status-${service.state.toLowerCase()}">${service.state}</span>
                    </div>
                    <div class="space-x-2">
                        <button class="btn btn-success btn-sm"
                                onclick="controlService('${escapeHtml(service.name)}', 'start')"
                                ${service.state === 'Running' ? 'disabled' : ''}>
                            Start
                        </button>
                        <button class="btn btn-warning btn-sm"
                                onclick="controlService('${escapeHtml(service.name)}', 'stop')"
                                ${service.state === 'Stopped' ? 'disabled' : ''}>
                            Stop
                        </button>
                        <button class="btn btn-primary btn-sm"
                                onclick="controlService('${escapeHtml(service.name)}', 'restart')">
                            Restart
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function controlService(name, action) {
            try {
                const response = await fetch(`/services/${encodeURIComponent(name)}/${action}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Operation failed');
                }

                addEventToLog('service', `${action.charAt(0).toUpperCase() + action.slice(1)} requested for "${name}"`);
                refreshServices();
            } catch (e) {
                console.error('Service control error:', e);
                addEventToLog('error', `Failed to ${action} service "${name}": ${e.message}`);
            }
        }

        async function healthCheckAll() {
            try {
                const response = await fetch('/services/health');
                const checks = await response.json();

                checks.forEach(check => {
                    addEventToLog('health', `${check.name}: ${check.status} ${check.message ? '- ' + check.message : ''}`);
                });
            } catch (e) {
                console.error('Health check error:', e);
                addEventToLog('error', 'Health check failed: ' + e.message);
            }
        }

        // =========================================================================
        // Initial Data Loading
        // =========================================================================
        async function loadInitialData() {
            // Load health
            try {
                const healthResponse = await fetch('/health');
                const health = await healthResponse.json();
                document.getElementById('status-value').textContent = health.status.toUpperCase();
                document.getElementById('status-value').className = 'mt-2 text-3xl font-semibold status-' + health.status;
                document.getElementById('uptime-value').textContent = formatUptime(health.uptime_seconds);
                document.getElementById('active-ops-value').textContent = health.active_indexing_operations;
            } catch (e) {
                console.error('Error loading health:', e);
            }

            // Load metrics
            try {
                const metricsResponse = await fetch('/metrics');
                const metrics = await metricsResponse.json();
                document.getElementById('metric-total-queries').textContent = metrics.total_queries;
                const successRate = metrics.total_queries > 0
                    ? ((metrics.successful_queries / metrics.total_queries) * 100).toFixed(1)
                    : '0.0';
                document.getElementById('metric-success-rate').textContent = successRate + '%';
                document.getElementById('metric-cache-hit').textContent = (metrics.cache_hit_rate * 100).toFixed(1) + '%';
                document.getElementById('metric-avg-response').textContent = metrics.average_response_time_ms.toFixed(1) + 'ms';
            } catch (e) {
                console.error('Error loading metrics:', e);
            }

            // Load services
            refreshServices();
        }

        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            if (days > 0) return `${days}d ${hours}h ${mins}m`;
            if (hours > 0) return `${hours}h ${mins}m ${secs}s`;
            if (mins > 0) return `${mins}m ${secs}s`;
            return `${secs}s`;
        }

        // =========================================================================
        // Initialize
        // =========================================================================
        document.addEventListener('DOMContentLoaded', function() {
            loadInitialData();
            connectSSE();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });

        // HTMX event handlers
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.successful) {
                const target = evt.detail.elt;
                if (target.textContent.includes('Reload Config')) {
                    addEventToLog('config', 'Configuration reload requested');
                } else if (target.textContent.includes('Shutdown')) {
                    addEventToLog('system', 'Server shutdown requested');
                }
            }
        });
    </script>
</body>
</html>
