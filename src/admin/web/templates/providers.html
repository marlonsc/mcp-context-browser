{% extends "base.html" %}

{% macro provider_card(provider) %}
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 hover:shadow-md transition-shadow">
    <div class="flex items-start justify-between">
        <div class="flex items-start space-x-3">
            <div class="flex-shrink-0">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                </div>
            </div>
            <div class="min-w-0 flex-1">
                <h3 class="text-sm font-medium text-gray-900 dark:text-white truncate">{{ provider.name }}</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400">{{ provider.provider_type | replace(from="_", to=" ") | title }}</p>
                <div class="mt-1">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                               {% if provider.status == 'active' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300{% else %}bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300{% endif %}">
                        {{ provider.status|title }}
                    </span>
                </div>
            </div>
        </div>
        <div class="flex space-x-2">
            <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
            </button>
            <button class="text-gray-400 hover:text-red-600 dark:hover:text-red-400">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </button>
        </div>
    </div>
</div>
{% endmacro %}

{% block title %}Providers - MCP Context Browser{% endblock %}

{% block content %}
<div x-data="providers()" class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Provider Management</h1>
        <button @click="$dispatch('open-modal', { modal: 'addProvider' })"
                class="inline-flex items-center px-4 py-2 bg-blue-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Add Provider
        </button>
    </div>

    <!-- Providers Grid -->
    <div id="providers-grid" 
         class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" 
         x-show="providers.length > 0" 
         x-transition>
        <template x-for="provider in providers" :key="provider.id">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 hover:shadow-md transition-shadow">
                <div class="flex items-start justify-between">
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="min-w-0 flex-1">
                            <h3 class="text-sm font-medium text-gray-900 dark:text-white truncate" x-text="provider.name"></h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400" x-text="provider.provider_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())"></p>
                            <div class="mt-1">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                      :class="provider.status === 'active' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300'"
                                      x-text="provider.status.charAt(0).toUpperCase() + provider.status.slice(1)"></span>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button @click="editProvider(provider)" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <button @click="deleteProvider(provider)" class="text-gray-400 hover:text-red-600 dark:hover:text-red-400">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Empty State -->
    <div x-show="providers.length === 0" class="text-center py-12" x-transition>
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No providers configured</h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Get started by adding your first provider.</p>
        <div class="mt-6">
            <button @click="$dispatch('open-modal', { modal: 'addProvider' })"
                    class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Add Provider
            </button>
        </div>
    </div>
</div>

<!-- Add Provider Modal -->
<div x-show="$store.modals.addProvider" x-cloak
     class="fixed inset-0 z-50 overflow-y-auto"
     @keydown.escape.window="$store.modals.addProvider = false">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" @click="$store.modals.addProvider = false">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>

        <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <form @submit.prevent="addProvider()">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">Add Provider</h3>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Provider Type</label>
                                    <select x-model="newProvider.provider_type"
                                            class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="">Select type...</option>
                                        <option value="embedding">Embedding Provider</option>
                                        <option value="vector_store">Vector Store Provider</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Provider Name</label>
                                    <select x-model="newProvider.name"
                                            class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="">Select provider...</option>
                                        <template x-if="newProvider.provider_type === 'embedding'">
                                            <option value="openai">OpenAI</option>
                                            <option value="ollama">Ollama</option>
                                        </template>
                                        <template x-if="newProvider.provider_type === 'vector_store'">
                                            <option value="milvus">Milvus</option>
                                            <option value="in-memory">In-Memory (Testing)</option>
                                        </template>
                                    </select>
                                </div>

                                <div x-show="newProvider.provider_type && newProvider.name">
                                    <div class="border-t pt-4">
                                        <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-3">Configuration</h4>
                                        <div class="space-y-3">
                                            <template x-if="newProvider.provider_type === 'embedding' && newProvider.name === 'openai'">
                                                <div>
                                                    <label class="block text-sm text-gray-700 dark:text-gray-300">API Key</label>
                                                    <input x-model="newProvider.config.api_key" type="password"
                                                           class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                                </div>
                                                <div>
                                                    <label class="block text-sm text-gray-700 dark:text-gray-300">Model</label>
                                                    <input x-model="newProvider.config.model" value="text-embedding-ada-002"
                                                           class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                                </div>
                                            </template>
                                            <template x-if="newProvider.provider_type === 'vector_store' && newProvider.name === 'milvus'">
                                                <div>
                                                    <label class="block text-sm text-gray-700 dark:text-gray-300">Host</label>
                                                    <input x-model="newProvider.config.host" value="localhost"
                                                           class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                                </div>
                                                <div>
                                                    <label class="block text-sm text-gray-700 dark:text-gray-300">Port</label>
                                                    <input x-model="newProvider.config.port" type="number" value="19530"
                                                           class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="submit"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Add Provider
                    </button>
                    <button type="button" @click="$store.modals.addProvider = false"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function providers() {
    return {
        providers: [],
        newProvider: {
            provider_type: '',
            name: '',
            config: {}
        },

        async init() {
            await this.loadProviders();
        },

        async loadProviders() {
            try {
                const response = await fetch('/admin/providers');
                const data = await response.json();
                if (data.success) {
                    this.providers = data.data;
                }
            } catch (error) {
                console.error('Failed to load providers:', error);
            }
        },

        async addProvider() {
            try {
                const response = await fetch('/admin/providers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.newProvider)
                });

                const data = await response.json();
                if (data.success) {
                    // Refresh providers list
                    await this.loadProviders();
                    this.$store.modals.addProvider = false;
                    this.resetNewProvider();
                    toast.success('Provider added successfully');
                } else {
                    toast.error(data.error || 'Failed to add provider', 'Provider Error');
                }
            } catch (error) {
                toast.error('Network error: ' + error.message, 'Connection Error');
            }
        },

        resetNewProvider() {
            this.newProvider = { provider_type: '', name: '', config: {} };
        },

        async editProvider(provider) {
            toast.warning('Provider editing not yet implemented', 'Feature Pending');
        },

        async deleteProvider(provider) {
            if (confirm(`Are you sure you want to delete provider "${provider.name}"? This action cannot be undone.`)) {
                try {
                    const response = await fetch(`/admin/providers/${provider.id}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();
                    if (data.success) {
                        await this.loadProviders();
                        toast.success(`Provider "${provider.name}" deleted successfully`, 'Provider Removed');
                    } else {
                        toast.error(data.error || 'Failed to delete provider', 'Deletion Failed');
                    }
                } catch (error) {
                    toast.error('Network error: ' + error.message, 'Connection Error');
                }
            }
        }
    }
}

// Global modal store
document.addEventListener('alpine:init', () => {
    Alpine.store('modals', {
        addProvider: false
    });
});

// Listen for modal events
document.addEventListener('open-modal', (event) => {
    const { modal } = event.detail;
    Alpine.store('modals', { ...Alpine.store('modals'), [modal]: true });
});
</script>
{% endblock %}