{% extends "base.html" %}
{% import "icons.html" as icons %}
{% block title %}Diagnostics - MCP Context Browser{% endblock %}

{% block content %}
<div x-data="diagnostics()" class="space-y-6">
    <div class="page-header">
        <div>
            <h1 class="page-title">System Diagnostics</h1>
            <p class="page-description">{{ page_description }}</p>
        </div>
        <button @click="runHealthCheck()" class="btn btn-primary">Run Health Check</button>
    </div>

    {% if health_check %}
    <!-- Health Overview -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card card-body metric-card">
            <div class="icon-box icon-box-md {% if health_check.overall_status == 'healthy' %}icon-box-success{% else %}icon-box-danger{% endif %}">
                {% if health_check.overall_status == 'healthy' %}
                {{ icons::icon(name="check-circle") }}
                {% else %}
                {{ icons::icon(name="warning") }}
                {% endif %}
            </div>
            <div class="metric-content">
                <div class="metric-label">Overall Status</div>
                <div class="metric-value capitalize">{{ health_check.overall_status }}</div>
            </div>
        </div>
        <div class="card card-body metric-card">
            <div class="icon-box icon-box-md icon-box-primary">{{ icons::icon(name="clock") }}</div>
            <div class="metric-content">
                <div class="metric-label">Check Duration</div>
                <div class="metric-value">{{ health_check.duration_ms }}ms</div>
            </div>
        </div>
        <div class="card card-body metric-card">
            <div class="icon-box icon-box-md icon-box-warning">{{ icons::icon(name="chart") }}</div>
            <div class="metric-content">
                <div class="metric-label">Checks Performed</div>
                <div class="metric-value">{{ health_check.checks | length }}</div>
            </div>
        </div>
    </div>

    <!-- Check Results -->
    <div class="card">
        <div class="card-header"><h3 class="font-medium">Health Check Results</h3></div>
        {% for check in health_check.checks %}
        <div class="card-body card-divider flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="icon-box icon-box-sm {% if check.status == 'healthy' %}icon-box-success{% else %}icon-box-danger{% endif %}">
                    {% if check.status == 'healthy' %}
                    {{ icons::icon(name="check", class="icon-sm") }}
                    {% else %}
                    {{ icons::icon(name="close", class="icon-sm") }}
                    {% endif %}
                </div>
                <div>
                    <h4 class="text-sm font-medium">{{ check.name }}</h4>
                    <p class="text-sm text-muted">{{ check.message }}</p>
                </div>
            </div>
            <span class="text-sm text-muted">{{ check.duration_ms }}ms</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Diagnostic Tools -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="card">
            <div class="card-header"><h3 class="font-medium">Connectivity Tests</h3></div>
            <div class="card-body space-y-3">
                <button @click="testAllProviders()" class="btn btn-primary w-full">Test All Providers</button>
                <button @click="testEmbedding()" class="btn btn-secondary w-full">Test Embedding Provider</button>
                <button @click="testVectorStore()" class="btn btn-secondary w-full">Test Vector Store</button>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><h3 class="font-medium">Performance Tests</h3></div>
            <div class="card-body space-y-3">
                <div>
                    <label class="input-label">Test Duration (seconds)</label>
                    <input type="number" x-model="perfTest.duration" class="input">
                </div>
                <div>
                    <label class="input-label">Concurrency</label>
                    <input type="number" x-model="perfTest.concurrency" class="input">
                </div>
                <button @click="runPerfTest()" class="btn btn-primary w-full">Run Performance Test</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function diagnostics() {
    return {
        perfTest: { duration: 60, concurrency: 10 },

        async runHealthCheck() {
            try {
                await API.get('/admin/diagnostic/health');
                toast.success('Health check completed');
                location.reload();
            } catch (e) { toast.error(e.message); }
        },

        async testAllProviders() {
            try {
                // Test each provider type sequentially
                await API.post('/admin/diagnostic/connectivity/embedding');
                await API.post('/admin/diagnostic/connectivity/vector_store');
                toast.success('Provider tests completed');
            } catch (e) { toast.error(e.message); }
        },

        async testEmbedding() {
            try {
                await API.post('/admin/diagnostic/connectivity/embedding');
                toast.success('Embedding test completed');
            } catch (e) { toast.error(e.message); }
        },

        async testVectorStore() {
            try {
                await API.post('/admin/diagnostic/connectivity/vector_store');
                toast.success('Vector store test completed');
            } catch (e) { toast.error(e.message); }
        },

        async runPerfTest() {
            try {
                await API.post('/admin/diagnostic/performance', this.perfTest);
                toast.success('Performance test started');
            } catch (e) { toast.error(e.message); }
        }
    };
}
</script>
{% endblock %}
