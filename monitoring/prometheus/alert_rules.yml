# MCP Context Browser Alert Rules
# Prometheus alerting rules for production monitoring

groups:
  # Service Health Alerts
  - name: mcp_service_health
    rules:
      - alert: McpServiceDown
        expr: up{job="mcb"} == 0
        for: 5m
        labels:
          severity: critical
          service: mcb
        annotations:
          summary: "MCP Context Browser service is down"
          description: "MCP Context Browser has been down for more than 5 minutes."

      - alert: McpHighErrorRate
        expr: rate(mcp_http_requests_total{status=~"5.."}[5m]) / rate(mcp_http_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
          service: mcb
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | printf \"%.2f\" }}% over the last 5 minutes."

      - alert: McpHighLatency
        expr: histogram_quantile(0.95, rate(mcp_http_request_duration_seconds_bucket[5m])) > 2.0
        for: 10m
        labels:
          severity: warning
          service: mcb
        annotations:
          summary: "High request latency detected"
          description: "95th percentile latency is {{ $value | printf \"%.2f\" }}s over the last 5 minutes."

  # Resource Usage Alerts
  - name: mcp_resource_usage
    rules:
      - alert: McpHighCpuUsage
        expr: mcp_cpu_usage_percent > 85
        for: 5m
        labels:
          severity: warning
          service: mcb
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is {{ $value | printf \"%.1f\" }}%."

      - alert: McpHighMemoryUsage
        expr: mcp_memory_usage_percent > 85
        for: 5m
        labels:
          severity: warning
          service: mcb
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is {{ $value | printf \"%.1f\" }}%."

      - alert: McpLowDiskSpace
        expr: (1 - mcp_disk_free_bytes / mcp_disk_total_bytes) > 0.85
        for: 10m
        labels:
          severity: warning
          service: mcb
        annotations:
          summary: "Low disk space"
          description: "Disk usage is {{ $value | printf \"%.1f\" }}%."

  # Cache Performance Alerts
  - name: mcp_cache_performance
    rules:
      - alert: McpLowCacheHitRate
        expr: mcp_cache_hit_rate < 0.7
        for: 15m
        labels:
          severity: warning
          service: mcb
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate is {{ $value | printf \"%.2f\" }}% (below 70% threshold)."

      - alert: McpHighCacheEvictions
        expr: rate(mcp_cache_evictions_total[5m]) > 100
        for: 5m
        labels:
          severity: warning
          service: mcb
        annotations:
          summary: "High cache eviction rate"
          description: "Cache evictions per second: {{ $value | printf \"%.1f\" }}."

  # SLO-based Alerts
  - name: mcp_slo_alerts
    rules:
      # 99.9% uptime SLO (8.77 hours downtime per year allowed)
      - alert: McpUptimeSLOViolation
        expr: (1 - (avg_over_time(up{job="mcb"}[30d]))) > 0.001
        labels:
          severity: critical
          service: mcb
          slo: uptime
        annotations:
          summary: "Uptime SLO violation"
          description: "Service uptime over 30 days: {{ $value | printf \"%.4f\" }}% (SLO: 99.9%)."

      # Query latency SLO (< 500ms P95)
      - alert: McpLatencySLOViolation
        expr: histogram_quantile(0.95, rate(mcp_http_request_duration_seconds_bucket{endpoint="/api/search"}[30d])) > 0.5
        labels:
          severity: warning
          service: mcb
          slo: latency
        annotations:
          summary: "Query latency SLO violation"
          description: "Search endpoint P95 latency: {{ $value | printf \"%.3f\" }}s (SLO: < 500ms)."

      # Error rate SLO (< 0.1% errors)
      - alert: McpErrorRateSLOViolation
        expr: rate(mcp_http_requests_total{status=~"5.."}[30d]) / rate(mcp_http_requests_total[30d]) > 0.001
        labels:
          severity: warning
          service: mcb
          slo: error_rate
        annotations:
          summary: "Error rate SLO violation"
          description: "Error rate over 30 days: {{ $value | printf \"%.4f\" }}% (SLO: < 0.1%)."

  # Capacity Planning Alerts
  - name: mcp_capacity_planning
    rules:
      - alert: McpHighConnectionCount
        expr: mcp_active_connections > 900
        for: 5m
        labels:
          severity: info
          service: mcb
        annotations:
          summary: "High connection count - capacity planning"
          description: "Active connections: {{ $value }} (approaching 1000 limit)."

      - alert: McpHighRequestRate
        expr: rate(mcp_http_requests_total[5m]) > 800
        for: 10m
        labels:
          severity: info
          service: mcb
        annotations:
          summary: "High request rate - capacity planning"
          description: "Request rate: {{ $value | printf \"%.1f\" }}/s (approaching 1000/s limit)."

      - alert: McpMemoryTrendIncreasing
        expr: predict_linear(mcp_memory_usage_percent[1h], 3600) > 90
        for: 30m
        labels:
          severity: info
          service: mcb
        annotations:
          summary: "Memory usage trending up - capacity planning"
          description: "Memory usage predicted to reach 90% in 1 hour."

  # Dependency Health Alerts
  - name: mcp_dependencies
    rules:
      - alert: McpRedisDown
        expr: up{job="redis"} == 0
        for: 2m
        labels:
          severity: critical
          service: redis
          dependency: mcb
        annotations:
          summary: "Redis dependency down"
          description: "Redis service is down, affecting MCP Context Browser caching."

      - alert: McpDatabaseDown
        expr: up{job="postgresql"} == 0
        for: 2m
        labels:
          severity: critical
          service: postgresql
          dependency: mcb
        annotations:
          summary: "Database dependency down"
          description: "PostgreSQL service is down, affecting MCP Context Browser metadata storage."

      - alert: McpVectorStoreDown
        expr: up{job="milvus"} == 0
        for: 5m
        labels:
          severity: critical
          service: milvus
          dependency: mcb
        annotations:
          summary: "Vector store dependency down"
          description: "Milvus vector store is down, affecting MCP Context Browser search functionality."